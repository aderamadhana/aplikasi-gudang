@{
    ViewData["Title"] = "Goods Receiving (GRN)";
}
<div class="section-header">
    <div class="section-title">
        <h2>Goods Receiving (GRN)</h2>
        <small>Menerima barang berdasarkan PO dan mencatat hasil penerimaan..</small>
    </div>
    <a class="btn-header" asp-controller="GoodReceive" asp-action="Create">
        <i class="bi bi-plus-circle"></i> Buat GRN Baru
    </a>
</div>

<div class="card card-modern">
    <div class="card-header p-3">
        <div class="container-fluid px-0">
            <div class="row g-2 align-items-center">
                <!-- Filter (tetap di kiri) -->
                <div class="col-12 col-md-3">
                    <button class="btn btn-outline-dark w-50" data-bs-toggle="modal" data-bs-target="#filter-data">
                        <i class="bi bi-funnel"></i> Filter Data
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="card-body">
        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover table-bordered table-striped align-middle" id="myTable" width="100%">
                <thead class="table-primary text-center">
                    <tr>
                        <th style="width: 5%;">No</th>
                        <th>GR Number</th>
                        <th>PO Number</th>
                        <th>Nama Supplier</th>
                        <th>Lokasi Stagging</th>
                        <th>Tanggal Terima</th>
                        <th>Status GR</th>
                        <th style="width: 10%;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- data via DataTables -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="filter-data" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Filter Data</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Status</label>
                    <select name="filtered-status" id="filtered-status" class="form-control">
                        <option value="true" selected>ENABLE</option>
                        <option value="false">DISABLE</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" onclick="applyFilter()">Terapkan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="import-data" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Import Data</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <a class="btn btn-outline-success mb-2" href="/template_import/template_master_customer.xlsx" )"
                   download>
                    <i class="bi bi-file-earmark-excel"></i> Download File
                </a>
                <div class="form-group">
                    <label>Upload File (.xlsx)</label>
                    <input type="file" id="file" class="form-control" name="file" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" onclick="importData()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1060;"></div>

<!-- Template alert (akan dipanggil lewat JS) -->
<script>
    function loadtable(){
        $('#myTable').DataTable().clear().destroy();
        let status = $('#filtered-status').val();
        $('#myTable').DataTable({
              processing: true,
              serverSide: true,
              scrollX: false,
              ajax: {
                    url: '/GoodReceive/GetGoodReceive?status='+status,
                    type: 'POST',
              },
              columns: [
                {
                  data: null, // tidak ambil dari data API
                  render: (data, type, row, meta) => meta.row + 1, // kasih nomor urut
                  defaultContent: ''
                },
                {
                    data: 'grnNo',
                    defaultContent: '',
                    render: (d, type, row) => {
                        if(row.grnNo != null && row.grnNo != ""){
                            return row.grnNo;
                        }else{
                            return "Data belum tersedia";
                        }
                    },
                },
                {
                    data: 'poNumber',
                    defaultContent: '',
                    render: (d, type, row) => {
                        if(row.poNumber != null && row.poNumber != ""){
                            return row.poNumber;
                        }else{
                            return "Data belum tersedia";
                        }
                    },
                },
                {
                    data: 'supplierName',
                },
                {
                    data: 'lokasiName',
                },
                {
                    data: 'tanggalTerima',
                    defaultContent: '',
                    render: function(data) {
                        if (!data) return "";
                        const d = new Date(data);
                        const day = d.getDate().toString().padStart(2, '0');
                        const month = (d.getMonth()+1).toString().padStart(2, '0');
                        const year = d.getFullYear();
                        return `${day}/${month}/${year}`;
                    }
                },
                {
                  data: 'statusGr',
                  render: (d, type, row) => {
                      if(row.statusGr == "Draft"){
                          return `<span class="badge bg-warning">Draft</span>`;
                      }else if(row.statusGr == "Posted"){
                          return `<span class="badge bg-primary">Posted</span>`;
                      }else if(row.statusGr == "Closed"){
                          return `<span class="badge bg-success">Closed</span>`;
                      }
                  },
                  defaultContent: '',
                  className:'text-center'
                },
                {
                  data: null,
                  render: (d, type, row) => {
                      const id   = row.grnId ?? '';
                      const name = String(row.roleName ?? '').replace(/"/g, '&quot;');

                      if(row.statusGr == "Draft"){
                          return `<a href="/GoodReceive/Edit/${id}"
                               class="btn btn-sm btn-primary me-2"
                               onclick="return confirmEdit(event, this)">
                              <i class="bi bi-pencil"></i> Edit
                            </a><button class="btn btn-sm me-2 btn-danger"
                                   data-id="${id}" data-name="${name}"
                                   onclick="hapusData('${id}','${name}')">
                             <i class="bi bi-trash"></i> Hapus
                           </button>`;
                      }else{
                          return `<a href="/GoodReceive/Detail/${id}"
                               class="btn btn-sm btn-info me-2"
                               onclick="return confirmEdit(event, this)">
                              <i class="bi bi-eye"></i> Detail
                            </a>`;
                      };
                  },
                  orderable: false,
                  searchable: false,
                  className: "text-center"
                }
              ]
        });

        $('#myTable').removeClass('dataTable no-footer');
    }

    // dipanggil saat klik "Terapkan"
    function applyFilter() {
      currentStatus = $('#filtered-status').val() ?? "";
      loadtable();
      $('#filter-data').modal('hide');
      $('#myTable').DataTable().columns.adjust();

    }

    // panggil sekali saat halaman siap (tanpa filter)
    $(function(){ loadtable(); });

    // ubah status
    function changeStatus(data_id, status){
        let text_status = 'DISABLE';
        if(status == true){
            text_status = 'ENABLE';
        }
        Swal.fire({
            title: 'Apakah Anda yakin?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
            // Contoh hit API pakai fetch
            fetch(`/GoodReceive/ChangeStatus/${data_id}?status=${status}`, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if(data.success == true){
                    showAlert(data.message, "success");
                    loadtable();
                }else{

                    showAlert(data.message, "error");
                    loadtable();
                }
            })
            .catch(err => {
                showAlert(err, "error");
            });
            }
        });
    }

    function importData(){
        var file = $("#file")[0];
        if (!file.files.length) {
            showAlert("Pilih file dulu.", "warning");
            return;
        }

        var fd = new FormData();
        fd.append("file", file.files[0]);

        $.ajax({
            url: "/GoodReceive/Import",
            type: "POST",
            data: fd,
            processData: false,
            contentType: false,
            success: function (data) {
                if(data.success == true){
                    showAlert("Import sukses. Inserted: " + data.inserted + ".", "success");
                    $("#file").val("");
                    $('#import-data').modal('hide');
                    loadtable();
                }else{
                    showAlert(data.message, "error");
                    loadtable();
                }
            },
            error: function (xhr) {
                showAlert(xhr, "error");
            }
        });
    }

    // hapus data
    function hapusData(data_id, data_nama){
        Swal.fire({
            title: 'Apakah Anda yakin?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
            // Contoh hit API pakai fetch
            fetch(`/GoodReceive/Delete/${data_id}`, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
            })
            .then(res => res.json())
            .then(data => {
                if(data.success == true){
                    showAlert(data.message, "success");
                    loadtable();
                }else{
                    showAlert(data.message, "error");
                    loadtable();
                }
            })
            .catch(err => {
                showAlert(err, "error");
                console.error(err);
            });
            }
        });
    }

    function exportData(){
        const status = $('#filtered-status').val();

        $.ajax({
          url: '/GoodReceive/Export',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ status }),
          xhrFields: { responseType: 'blob' }, // terima file sebagai blob
          success: function (data, statusText, xhr) {
            // Ambil nama file dari Content-Disposition kalau ada
            const dispo = xhr.getResponseHeader('Content-Disposition') || '';
            let fileName = 'export_master_customer.xlsx';
            const m = dispo.match(/filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i);
            if (m) fileName = decodeURIComponent(m[1] || m[2]);

            // Buat link download sementara
            const blob = new Blob([data], { type: xhr.getResponseHeader('Content-Type') || 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          },
          error: function (xhr) {
              showAlert('Gagal export: ' + xhr.status + ' ' + xhr.statusText, "error");
          }
        });
    }
</script>