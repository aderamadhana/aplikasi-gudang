@using System.Text.Json
@{
    ViewData["Title"] = "Edit Good Receive";
    var purchase_order = ViewBag.PurchaseOrder;
    var lokasi_stagging = ViewBag.LokasiStagging;
    var username = ViewBag.UserName;
    var user_id = ViewBag.UserId;
    var good_receive = ViewBag.GoodReceive;
    var good_receive_json = good_receive.Details;
    var id = ViewBag.Id;
}

<!-- Header -->
<div class="page-header d-flex align-items-center justify-content-between">
    <div>
        <h2 class="h4 mb-0">Form Goods Receive</h2>
        <small class="opacity-75">Menerima barang berdasarkan PO dan mencatat hasil penerimaan</small>
    </div>
</div>
<form method="post" enctype="multipart/form-data" id="poForm">

    <!-- DETAIL -->
    <div class="card card-modern mb-3">
        <div class="card-header">
            <h5><i class="bi bi-receipt"></i> Data GRN</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">PO Number</label>
                    <select class="form-select select2 readonly-select" required id="po_number">
                        <option value="" selected disabled>Pilih PO Number</option>
                        @foreach (var items in purchase_order)
                        {
                            <option value="@items.PurchaseOrderId" selected="@(items.PurchaseOrderId == good_receive.PoId)">@items.PoNumber</option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">Supplier</label>
                    <input type="text" class="form-control" id="nama_supplier" name="nama_supplier" value="@good_receive.SupplierName" required readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label required">Tanggal Terima</label>
                    <input type="date" class="form-control" id="tanggal_receive" value="@(good_receive.TanggalTerima.ToString("yyyy-MM-dd"))" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label required">User</label>
                    <input type="text" class="form-control" id="user_id" value="@good_receive.FullName" required value="@username" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label required">Lokasi Stagging</label>
                    <select class="form-select select2" id="lokasi_stagging" required>
                        <option value="" selected disabled>Pilih Lokasi Staging</option>
                        @foreach (var items in lokasi_stagging)
                        {
                            <option value="@items.IdLokasi" selected="@(items.IdLokasi == good_receive.LokasiId)">@items.Warehouse - @items.TipeLokasi</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- ITEMS -->
    <div class="card card-modern mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0"><i class="bi bi-bag-check"></i> Form Detail Pengiriman</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="orderTable" class="table table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>Nama Item</th>
                            <th style="width:8%">Qty Order</th>
                            <th>Qty Received</th>
                            <th style="width:8%">Unit</th>
                            <th>Lot No</th>
                            <th>Expiry</th>
                            <th>Status QC</th>
                        </tr>
                    </thead>
                    <tbody class="input-tight">
                        @foreach (var item in good_receive_json)
                        {
                            <tr>
                                <td>
                                    <span>@item.ItemName</span>
                                    <input type="hidden" class="item-id" name="item_id[]" value="@item.ItemId">
                                    <input type="hidden" class="item-name" name="item_name[]" value="@item.ItemName">
                                    <input type="hidden" class="qty-order" name="qty_order[]" value="@item.QtyOrder">
                                </td>
                                <td>
                                    <span>@item.QtyOrder</span>
                                </td>
                                <td>
                                    <input type="number" class="form-control qty-input" name="qty_received[]" min="0" step="1" max="@item.QtyOrder" value="@item.QtyReceived">
                                </td>
                                <td>
                                    <span>@item.UnitMeasureName</span>
                                </td>
                                <td>
                                    <span>@item.LotNo</span>
                                </td>
                                <td>
                                    <input type="date" class="form-control expiry" name="expiry[]" value="@(item.Expiry.ToString("yyyy-MM-dd"))">
                                </td>
                                <td>
                                    <select class="form-select status-qc" name="status_qc[]">
                                        <option value="ok" selected="@(item.StatusQC == "ok")">ok</option>
                                        <option value="hold" selected="@(item.StatusQC == "hold")">hold</option>
                                        <option value="reject" selected="@(item.StatusQC == "reject")">reject</option>
                                    </select>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Summary di bawah table -->
            <div class="mt-3 summary-bar">
                <div>
                    <span class="me-2 text-muted">Ringkasan:</span>
                    <span class="summary-pill">Total Item: <span id="totalItem">1</span></span>
                    <span class="summary-pill">Total Qty Received: <span id="totalQtyBadge">0</span></span>
                </div>
                <div class="form-actions">
                    <button type="reset" class="btn btn-light border">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                    </button>
                    <button id="btnSimpanDraft" class="btn btn-warning">
                        <i class="bi bi-save2 me-1"></i> Simpan Draft
                    </button>
                    <button id="btnSimpanGr" class="btn btn-primary">
                        <i class="bi bi-save2 me-1"></i> Simpan Goods Receive
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    function recalcTotals() {
      let totalQty = 0;
      $('.qty-input').each(function() {
        const val = parseFloat($(this).val());
        if (!isNaN(val)) totalQty += val;
      });
      $('#totalQty').val(totalQty);
      $('#totalQtyBadge').text(totalQty);

      const itemCount = $('#orderTable tbody tr').length;
      $('#totalItem').text(itemCount);
    }

    $(document).ready(function () {
        // Inisialisasi Select2
        $('#po_number').select2();

        // Jadikan Select2 readonly (user tidak bisa ganti, tapi value tetap dikirim)
        $('#po_number').on('select2:opening select2:unselecting', function (e) {
            e.preventDefault();
        });
      var poData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(purchase_order));

      $("#po_number").on("change", function(){
            const selectedPo = $(this).val();
            let data = poData.find(x => x.PurchaseOrderId === selectedPo);
            let lot_no = generateLotNo("LOT", data.TanggalPo);

            if (!data) return;
            $('#nama_supplier').val(data.SupplierName);


            // kosongkan semua baris dulu
            $(".input-tight").empty();

            // looping detail PO
            data.Details.forEach(d => {
                let row = `
                <tr>
                    <td>
                        ${d.ItemName}
                        <input type="hidden" class="item-id" name="item_id[]" value="${d.ItemId}">
                        <input type="hidden" class="item-name" name="item_name[]" value="${d.ItemName}">
                        <input type="hidden" class="qty-order" name="qty_order[]" value="${d.QtyOrder}">
                    </td>
                    <td class="text-center">${d.QtyOrder}</td>
                    <td><input type="number" class="form-control qty-input" name="qty_received[]" min="0" step="1" max="${d.QtyOrder}"></td>
                    <td class="text-center">${d.UnitMeasureName}</td>
                    <td><input type="text" class="form-control lot-no" name="lot_no[]" value="`+lot_no+`" readonly></td>
                    <td><input type="date" class="form-control expiry" name="expiry[]"></td>
                    <td>
                        <select class="form-select status-qc" name="status_qc[]">
                            <option value="ok">ok</option>
                            <option value="hold">hold</option>
                            <option value="reject">reject</option>
                        </select>
                    </td>
                </tr>`;

                $(".input-tight").append(row);
            });

            // Reinit Select2 setelah append baris
            $(".select2").select2();
      });

      // Recalc saat qty berubah
      $('#orderTable').on('input', '.qty-input', recalcTotals);

      // Reset form
      $('#poForm').on('reset', function () {
        // beri jeda agar input ter-reset dulu
        setTimeout(function () {
          // sisakan 1 baris
            const $tbody = $('#orderTable tbody');
            $tbody.find('tr:gt(0)').remove();
            $tbody.find('input').val('');
            $tbody.find('select').each(function(){ this.selectedIndex = 0; });

            // ✅ Reset select2 PO Number
            $('#po_number').val('').trigger('change');

            // ✅ Reset Lokasi Staging select2
            $('#lokasi_stagging').val('').trigger('change');

            // ✅ Reset field supplier & tanggal
            $('#nama_supplier').val('');
            $('#tanggal_po').val('');

            const defaultRow = `
                <tr class="text-center">
                    <td colspan="7">Pilih PO Number Terlebih Dahulu!</td>
                </tr>
            `;
            $('.input-tight').html(defaultRow);

            if (typeof recalcTotals === 'function') {
                recalcTotals();
            }
        }, 0);
      });

      // Hitung awal
      recalcTotals();
    });

    let batchCounter = 1;
    function generateLotNo(productCode, tanggalPo) {
        const date = new Date(tanggalPo);

        const y = date.getFullYear().toString().slice(-2); // ambil dua digit tahun
        const m = String(date.getMonth() + 1).padStart(2, '0'); // bulan 01-12
        const d = String(date.getDate()).padStart(2, '0'); // tanggal 01-31

        // Format lot number, misalnya: YKL251103-001
        const lotNo = `${productCode}${y}${m}${d}-${String(batchCounter).padStart(3, '0')}`;
        batchCounter++; // naikkan counter setiap kali generate
        return lotNo;
    }

    $(document).on('input', '.qty-input', function () {
        let max = parseInt($(this).attr('max')) || 0;
        let val = parseInt($(this).val()) || 0;

        if (val > max) {
            showAlert(`Qty Received tidak boleh lebih dari ${max}`, 'warning');
            $(this).val('');
            recalcTotals();

        }
    });

    // Hook tombol
    $(document).on('click', '#btnSimpanDraft', function(e){
        e.preventDefault();
        saveGr(false);
    });
    $(document).on('click', '#btnSimpanGr', function(e){
        e.preventDefault();
        saveGr(true);
    });

    async function saveGr(isPost){
        var grId = "@id";
        const dto = {
            poId: $('#po_number').val() || '',
            poNo: $('#po_number option:selected').text() || null,
            tanggalTerima: $('#tanggal_receive').val(),     // "dd/MM/yyyy"
            statusGr: isPost ? 'Posted' : 'Draft',
            lokasiId: $('#lokasi_stagging').val(),
            lokasiName: $('#lokasi_stagging option:selected').text() || null,
            items: collectItems(),
            status: true
        };
        // dto.totalQty = calcTotalQty(dto.items);

        const res = await fetch(`/GoodReceive/Edit?post=${isPost}&grId=${grId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrf()
            },
            body: JSON.stringify(dto)
        });

        if (!res.ok) {
            const err = await res.json().catch(()=> ({}));
            showAlert(err && err.message, 'danger');
            return;
        }

        const data = await res.json();
        showAlert(data.message, 'success');
        setTimeout(() => {
            window.location.href = '/GoodReceive/Index';
        }, 1200);
    }

    function getCsrf() {
        return document.querySelector('input[name="__RequestVerificationToken"]').value;
    }

    function collectItems() {
        const items = [];
        $('#orderTable tbody tr').each(function(){
            const row = $(this);
            items.push({
                itemId: row.find('.item-id').val() || null,
                itemName: row.find('.item-name').val() || '',
                qtyOrder: parseInt(row.find('.qty-order').val() || '0', 10),
                qtyReceived: parseInt(row.find('.qty-input').val() || '0', 10),
                lotNo: row.find('.lot-no').val() || null,
                expiry: row.find('.expiry').val() || null,
                statusQc: row.find('.status-qc').val() || null
            });
        });
        return items;
    }

</script>