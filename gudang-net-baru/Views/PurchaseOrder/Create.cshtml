@{
    ViewData["Title"] = "Tambah Purchase Order";
}

<!-- Header -->
<div class="page-header d-flex align-items-center justify-content-between">
    <div>
        <h2 class="h4 mb-0">Form Purchase Order</h2>
        <small class="opacity-75">Buat PO baru untuk pembelian barang</small>
    </div>
</div>

<form method="post" enctype="multipart/form-data" id="poForm">

    <!-- DETAIL -->
    <div class="card card-modern mb-3">
        <div class="card-header">
            <h5><i class="bi bi-receipt"></i> Data Supplier</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">Supplier</label>
                    <select class="form-select" name="supplier" required>
                        <option value="" selected disabled>Pilih Supplier</option>
                        <option value="SUP-001">SUP-001 • PT Sejahtera</option>
                        <option value="SUP-002">SUP-002 • CV Maju Jaya</option>
                        <option value="SUP-003">SUP-003 • UD Sentosa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label required">Tanggal PO</label>
                    <input type="date" class="form-control" name="tanggal_po" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label required">Total Qty</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="total_qty" id="totalQty" readonly placeholder="0">
                        <span class="input-group-text">pcs</span>
                    </div>
                    <div class="form-text">Otomatis dihitung dari Items.</div>
                </div>
                <div class="col-12">
                    <label class="form-label">Keterangan</label>
                    <textarea class="form-control" name="keterangan" rows="2" placeholder="Catatan tambahan (opsional)"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ITEMS -->
    <div class="card card-modern mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0"><i class="bi bi-bag-check"></i> Items Order</h5>
            <div class="floating-add">
                <button type="button" class="btn btn-success btn-sm" id="addRowBtn">
                    <i class="bi bi-plus-lg me-1"></i> Tambah Item
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="orderTable" class="table table-bordered align-middle">
                    <thead>
                        <tr>
                            <th style="width:12%">SKU</th>
                            <th>Nama Item</th>
                            <th style="width:14%">Qty Order</th>
                            <th style="width:12%">Unit</th>
                            <th>Keterangan</th>
                            <th style="width:48px"></th>
                        </tr>
                    </thead>
                    <tbody class="input-tight">
                        <tr>
                            <td><input type="text" class="form-control" name="sku[]" placeholder="SKU"></td>
                            <td><input type="text" class="form-control" name="nama_item[]" placeholder="Nama item"></td>
                            <td>
                                <input type="number" class="form-control qty-input" name="qty_order[]" min="0" step="1" placeholder="0">
                            </td>
                            <td>
                                <select class="form-select" name="unit[]">
                                    <option value="pcs">pcs</option>
                                    <option value="box">box</option>
                                    <option value="kg">kg</option>
                                </select>
                            </td>
                            <td><input type="text" class="form-control" name="keterangan[]" placeholder="Catatan (opsional)"></td>
                            <td class="text-center">
                                <button type="button" class="btn btn-outline-danger btn-sm removeRowBtn" title="Hapus baris">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Summary di bawah table -->
            <div class="mt-3 summary-bar">
                <div>
                    <span class="me-2 text-muted">Ringkasan:</span>
                    <span class="summary-pill">Total Item: <span id="totalItem">1</span></span>
                    <span class="summary-pill">Total Qty: <span id="totalQtyBadge">0</span></span>
                </div>
                <div class="form-actions">
                    <button type="reset" class="btn btn-light border">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save2 me-1"></i> Simpan Draft
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save2 me-1"></i> Simpan PO
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    // Tambah baris item
    function newRowTemplate() {
      return `
        <tr>
          <td><input type="text" class="form-control" name="sku[]" placeholder="SKU"></td>
          <td><input type="text" class="form-control" name="nama_item[]" placeholder="Nama item"></td>
          <td><input type="number" class="form-control qty-input" name="qty_order[]" min="0" step="1" placeholder="0"></td>
          <td>
            <select class="form-select" name="unit[]">
              <option value="pcs">pcs</option>
              <option value="box">box</option>
              <option value="kg">kg</option>
            </select>
          </td>
          <td><input type="text" class="form-control" name="keterangan[]" placeholder="Catatan (opsional)"></td>
          <td class="text-center">
            <button type="button" class="btn btn-outline-danger btn-sm removeRowBtn" title="Hapus baris">
              <i class="bi bi-trash3"></i>
            </button>
          </td>
        </tr>
      `;
    }

    function recalcTotals() {
      let totalQty = 0;
      $('.qty-input').each(function() {
        const val = parseFloat($(this).val());
        if (!isNaN(val)) totalQty += val;
      });
      $('#totalQty').val(totalQty);
      $('#totalQtyBadge').text(totalQty);

      const itemCount = $('#orderTable tbody tr').length;
      $('#totalItem').text(itemCount);
    }

    $(document).ready(function () {
      // Tambah baris
      $('#addRowBtn').on('click', function () {
        $('#orderTable tbody').append(newRowTemplate());
        recalcTotals();
      });

      // Hapus baris (event delegation)
      $('#orderTable').on('click', '.removeRowBtn', function () {
        $(this).closest('tr').remove();
        recalcTotals();
      });

      // Recalc saat qty berubah
      $('#orderTable').on('input', '.qty-input', recalcTotals);

      // Reset form
      $('#poForm').on('reset', function () {
        // beri jeda agar input ter-reset dulu
        setTimeout(function () {
          // sisakan 1 baris
          const $tbody = $('#orderTable tbody');
          $tbody.find('tr:gt(0)').remove();
          $tbody.find('input').val('');
          $tbody.find('select').each(function(){ this.selectedIndex = 0; });
          recalcTotals();
        }, 0);
      });

      // Validasi ringan saat submit
      $('#poForm').on('submit', function (e) {
        const supplier = $('[name="supplier"]').val();
        const tanggal = $('[name="tanggal_po"]').val();
        if (!supplier || !tanggal) {
          e.preventDefault();
          alert('Supplier dan Tanggal PO wajib diisi.');
          return false;
        }
        // Pastikan ada minimal 1 baris qty > 0
        let hasQty = false;
        $('.qty-input').each(function(){ if (parseFloat($(this).val()) > 0) hasQty = true; });
        if (!hasQty) {
          e.preventDefault();
          alert('Minimal satu item harus memiliki Qty > 0.');
          return false;
        }
      });

      // Hitung awal
      recalcTotals();
    });
</script>