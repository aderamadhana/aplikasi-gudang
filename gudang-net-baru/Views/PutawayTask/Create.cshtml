@{
    ViewData["Title"] = "Tambah Putaway Task";
    var good_receive = ViewBag.GoodReceive;
}

<!-- Header -->
<div class="page-header d-flex align-items-center justify-content-between">
    <div>
        <h2 class="h4 mb-0">Form Putaway Task</h2>
        <small class="opacity-75">Membuat tugas pemindahan stok dari Staging ke Storage</small>
    </div>
</div>

<form method="post" enctype="multipart/form-data" id="poForm">

    <!-- DETAIL -->
    <div class="row g-3">

        <!-- LEFT: FORM GRN -->
        <div class="col-lg-4">
            <div class="card card-modern h-100">
                <div class="card-header">
                    <h5><i class="bi bi-receipt"></i> Data GRN</h5>
                </div>

                <div class="card-body pt-0">

                    <!-- GRN Number -->
                    <div class="detail-group">
                        <label class="detail-label">GRN Number</label>
                        <select class="form-select select2" id="grn_number" required>
                            <option value="" selected disabled>Pilih GRN Number</option>
                            @foreach (var items in good_receive)
                            {
                                <option value="@items.GrnId">@items.GrnNo</option>
                            }
                        </select>
                    </div>

                    <hr>

                    <!-- Purchase Order -->
                    <div class="detail-group">
                        <label class="detail-label">Purchase Order</label>
                        <div class="detail-value" id="purchase_order">-</div>
                    </div>

                    <!-- Supplier -->
                    <div class="detail-group">
                        <label class="detail-label">Supplier</label>
                        <div class="detail-value" id="nama_supplier">-</div>
                    </div>

                    <!-- Tanggal Terima -->
                    <div class="detail-group">
                        <label class="detail-label">Tanggal Terima</label>
                        <div class="detail-value" id="tanggal_receive">-</div>
                    </div>

                    <!-- Lokasi Stagging -->
                    <div class="detail-group">
                        <label class="detail-label">Lokasi Stagging</label>
                        <div class="detail-value" id="lokasi_stagging">-</div>
                    </div>

                    <!-- Status GRN -->
                    <div class="detail-group">
                        <label class="detail-label">Status GRN</label>
                        <div class="detail-value" id="status_grn">-</div>
                    </div>

                    <!-- User ID -->
                    <div class="detail-group mb-0">
                        <label class="detail-label">Nama</label>
                        <div class="detail-value" id="user_name"></div>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT: ITEMS TABLE -->
        <div class="col-lg-8">
            <div class="card card-modern">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0"><i class="bi bi-bag-check"></i> Items From GRN</h5>
                </div>

                <div class="card-body">
                    <div class="table-responsive">
                        <table id="orderTable" class="table table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>Nama Item</th>
                                    <th>Qty Grn</th>
                                    <th>Qty Already Putaway</th>
                                    <th>Qty Remaining</th>
                                </tr>
                            </thead>
                            <tbody class="input-tight">
                                <tr class="text-center">
                                    <td colspan="5">Pilih GRN Number Terlebih Dahulu!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    <div class="mt-3 summary-bar d-flex justify-content-between align-items-center">
                        <div>
                            <span class="me-2 text-muted">Ringkasan:</span>
                            <span class="summary-pill">Total Item: <span id="totalItem">1</span></span>
                            <span class="summary-pill">Total Qty Received: <span id="totalQtyBadge">0</span></span>
                        </div>
                        <div class="form-actions">
                            <button type="reset" class="btn btn-light border">
                                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                            </button>
                            <button id="btnSimpanDraft" class="btn btn-warning">
                                <i class="bi bi-save2 me-1"></i> Simpan Draft
                            </button>
                            <button id="btnSimpanGr" class="btn btn-primary">
                                <i class="bi bi-save2 me-1"></i> Simpan Goods Receive
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

</form>
<script>
    function recalcTotals() {
      let totalQty = 0;
      $('.qty-input').each(function() {
        const val = parseFloat($(this).val());
        if (!isNaN(val)) totalQty += val;
      });
      $('#totalQty').val(totalQty);
      $('#totalQtyBadge').text(totalQty);

      const itemCount = $('#orderTable tbody tr').length;
      $('#totalItem').text(itemCount);
    }

    $(document).ready(function () {
      var grnData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(good_receive));
      console.log(grnData)

      $("#grn_number").on("change", function(){
            const selectedGrn = $(this).val();
            let data = grnData.find(x => x.GrnId === selectedGrn);
            console.log(data.PoNo);
            if (!data) return;
            $('#purchase_order').text(data.PoNo || '-');
            $('#nama_supplier').text(data.SupplierName || '-'); // Mungkin bukan UserId?

            // Format tanggal jika perlu
            let tanggal = data.TanggalTerima
                ? new Date(data.TanggalTerima).toLocaleDateString('id-ID')
                : '-';
            $('#tanggal_receive').text(tanggal);

            $('#lokasi_stagging').text(data.LokasiName || '-');
            $('#status_grn').text(data.StatusGr || '-');
            $('#user_name').text(data.UserName || '-');


            $(".input-tight").empty();

            data.Details.forEach(d => {
                let row = `
                <tr>
                    <td>
                        <input type="checkbox" class="form_control" name="grn_detail_id[]" value="${d.GrnDetailId}">
                        <input type="hidden" class="item-id" name="item_id[]" value="${d.ItemId}">
                        <input type="hidden" class="item-name" name="item_name[]" value="${d.ItemName}">
                        <input type="hidden" class="qty-order" name="qty_received[]" value="${d.QtyReceived}">
                    </td>
                    <td>${d.ItemName}</td>
                    <td>${d.QtyReceived}</td>
                    <td><input type="number" class="form-control qty-putaway" name="qty_received[]" min="0" step="1" value="0" max="${d.QtyReceived}"></td>
                    <td class="text-center">${d.QtyReceived}</td>                
                </tr>`;

                $(".input-tight").append(row);
            });

            $(".select2").select2();
      });

      // Recalc saat qty berubah
      $('#orderTable').on('input', '.qty-input', recalcTotals);

      // Reset form
      $('#poForm').on('reset', function () {
        // beri jeda agar input ter-reset dulu
        setTimeout(function () {
          // sisakan 1 baris
            const $tbody = $('#orderTable tbody');
            $tbody.find('tr:gt(0)').remove();
            $tbody.find('input').val('');
            $tbody.find('select').each(function(){ this.selectedIndex = 0; });

            // ✅ Reset select2 PO Number
            $('#po_number').val('').trigger('change');

            // ✅ Reset Lokasi Staging select2
            $('#lokasi_stagging').val('').trigger('change');

            // ✅ Reset field supplier & tanggal
            $('#nama_supplier').val('');
            $('#tanggal_po').val('');

            const defaultRow = `
                <tr class="text-center">
                    <td colspan="7">Pilih PO Number Terlebih Dahulu!</td>
                </tr>
            `;
            $('.input-tight').html(defaultRow);

            if (typeof recalcTotals === 'function') {
                recalcTotals();
            }
        }, 0);
      });

      // Hitung awal
      recalcTotals();
    });

    let batchCounter = 1;
    function generateLotNo(productCode, tanggalPo) {
        const date = new Date(tanggalPo);

        const y = date.getFullYear().toString().slice(-2); // ambil dua digit tahun
        const m = String(date.getMonth() + 1).padStart(2, '0'); // bulan 01-12
        const d = String(date.getDate()).padStart(2, '0'); // tanggal 01-31

        // Format lot number, misalnya: YKL251103-001
        const lotNo = `${productCode}${y}${m}${d}-${String(batchCounter).padStart(3, '0')}`;
        batchCounter++; // naikkan counter setiap kali generate
        return lotNo;
    }

    $(document).on('input', '.qty-input', function () {
        let max = parseInt($(this).attr('max')) || 0;
        let val = parseInt($(this).val()) || 0;

        if (val > max) {
            showAlert(`Qty Received tidak boleh lebih dari ${max}`, 'warning');
            $(this).val('');
            recalcTotals();

        }
    });

    // Hook tombol
    $(document).on('click', '#btnSimpanDraft', function(e){
        e.preventDefault();
        saveGr(false);
    });
    $(document).on('click', '#btnSimpanGr', function(e){
        e.preventDefault();
        saveGr(true);
    });

    async function saveGr(isPost){
        const dto = {
            poId: $('#po_number').val() || '',
            poNo: $('#po_number option:selected').text() || null,
            tanggalTerima: $('#tanggal_receive').val(),     // "dd/MM/yyyy"
            statusGr: isPost ? 'Posted' : 'Draft',
            lokasiId: $('#lokasi_stagging').val(),
            lokasiName: $('#lokasi_stagging option:selected').text() || null,
            items: collectItems(),
            status: true
        };
        // dto.totalQty = calcTotalQty(dto.items);

        const res = await fetch(`/GoodReceive/Create?post=${isPost}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrf()
            },
            body: JSON.stringify(dto)
        });

        if (!res.ok) {
            const err = await res.json().catch(()=> ({}));
            showAlert(err && err.message, 'danger');
            return;
        }

        const data = await res.json();
        showAlert(data.message, 'success');
        setTimeout(() => {
            window.location.href = '/GoodReceive/Index';
        }, 1200);
    }

    function getCsrf() {
        return document.querySelector('input[name="__RequestVerificationToken"]').value;
    }

    function collectItems() {
        const items = [];
        $('#orderTable tbody tr').each(function(){
            const row = $(this);
            items.push({
                itemId: row.find('.item-id').val() || null,
                itemName: row.find('.item-name').val() || '',
                qtyOrder: parseInt(row.find('.qty-order').val() || '0', 10),
                qtyReceived: parseInt(row.find('.qty-input').val() || '0', 10),
                lotNo: row.find('.lot-no').val() || null,
                expiry: row.find('.expiry').val() || null,
                statusQc: row.find('.status-qc').val() || null
            });
        });
        return items;
    }

</script>